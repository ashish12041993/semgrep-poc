name: Semgrep Scanner Workflow

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string
      repo_name:
        required: true
        type: string
    secrets:
      PAT_TOKEN:
        required: true
      SEMGREP_APP_TOKEN:
        required: true

jobs:
  semgrep:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v3
        with:
          repository: ${{ inputs.repo_name }}
          ref: refs/pull/${{ inputs.pr_number }}/merge
          token: ${{ secrets.PAT_TOKEN }}

      - name: Get Changed Files
        id: changed
        uses: tj-actions/changed-files@v44
        with:
          token: ${{ secrets.PAT_TOKEN }}
          files: |
            **/*.py
            **/*.js
            **/*.ts
            **/*.go
            **/*.java
            **/*.yaml
            **/*.yml
            **/*.rb
            **/*.php

      - name: List Changed Files
        run: |
          echo "Changed files:"
          echo "${{ steps.changed.outputs.all_changed_files }}"

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep and upload to Semgrep Cloud
        if: ${{ steps.changed.outputs.all_changed_files != '' }}
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        run: |
          echo "${{ steps.changed.outputs.all_changed_files }}" > changed-files.txt
          semgrep ci --config=p/ci --include $(cat changed-files.txt | tr '\n' ' ')
        continue-on-error: true

      - name: Run Semgrep again for local JSON output
        if: ${{ steps.changed.outputs.all_changed_files != '' }}
        run: |
          semgrep --config=p/ci --include $(cat changed-files.txt | tr '\n' ' ') --json > semgrep-output.json
        continue-on-error: true

      - name: Format Semgrep output for PR comment
        if: ${{ steps.changed.outputs.all_changed_files != '' }}
        run: |
          echo "## 🛡️ Semgrep Report (Changed Files Only)" > comment.md

          if jq -e '.results | length > 0' semgrep-output.json > /dev/null; then
            echo "" >> comment.md
            echo "| File | Line | Rule ID | Message |" >> comment.md
            echo "|------|------|---------|---------|" >> comment.md
            jq -r '.results[] | "| `\(.path)` | \(.start.line // "-") | `\(.check_id)` | \(.extra.message | gsub("\n"; " ")) |"' semgrep-output.json >> comment.md
          else
            echo "" >> comment.md
            echo "✅ No issues found." >> comment.md
          fi

      - name: Comment Semgrep results on PR
        if: ${{ steps.changed.outputs.all_changed_files != '' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: semgrep
          path: comment.md
